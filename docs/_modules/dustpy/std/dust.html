<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>dustpy.std.dust &mdash; dustpy  documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=92fd9be5" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css?v=fd3f3429" />

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../../_static/documentation_options.js?v=5929fcd5"></script>
        <script src="../../../_static/doctools.js?v=9a2dae69"></script>
        <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html">
            
              <img src="../../../_static/logo.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../1_basics.html">1. Basic usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../2_simple_customization.html">2. Simple Customization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../3_advanced_customization.html">3. Advanced Customization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../4_standard_model.html">4. The Standard Model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../5_dust_coagulation.html">5. Dust Coagulation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../6_dust_evolution.html">6. Dust Evolution</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../7_gas_evolution.html">7. Gas Evolution</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dustpylib.html">Library: dustpylib</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../test_analytical_coagulation_kernels.html">Test: Analytical Coagulation Kernels</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../test_gas_evolution.html">Test: Gas Evolution</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../example_ice_lines.html">Example: Ice Lines</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../example_planetary_gaps.html">Example: Planetary Gaps</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../example_planetesimal_formation.html">Example: Planetesimal Formation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../A_citation.html">Appendix A: Citation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../B_publications.html">Appendix B: List of Publications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../C_contrib_bug_feature.html">Appendix C: Contributing/Bugs/Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../D_discussions.html">Appendix D: DustPy Discussions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../E_changelog.html">Appendix E: Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api.html">Module Reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">dustpy</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">dustpy.std.dust</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for dustpy.std.dust</h1><div class="highlight"><pre>
<span></span><span class="sd">&#39;&#39;&#39;Module containing standard functions for the dust.&#39;&#39;&#39;</span>


<span class="kn">import</span> <span class="nn">dustpy.constants</span> <span class="k">as</span> <span class="nn">c</span>
<span class="kn">from</span> <span class="nn">dustpy.std</span> <span class="kn">import</span> <span class="n">dust_f</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">scipy.sparse</span> <span class="k">as</span> <span class="nn">sp</span>

<span class="kn">from</span> <span class="nn">simframe.integration</span> <span class="kn">import</span> <span class="n">Scheme</span>


<div class="viewcode-block" id="boundary">
<a class="viewcode-back" href="../../../api/dustpy.std.dust.boundary.html#dustpy.std.dust.boundary">[docs]</a>
<span class="k">def</span> <span class="nf">boundary</span><span class="p">(</span><span class="n">sim</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Function sets the boundary condition of dust surface density.</span>
<span class="sd">    Not implemented, yet.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    sim : Frame</span>
<span class="sd">        Parent simulation frame&quot;&quot;&quot;</span>
    <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">boundary</span><span class="o">.</span><span class="n">inner</span><span class="o">.</span><span class="n">setboundary</span><span class="p">()</span>
    <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">boundary</span><span class="o">.</span><span class="n">outer</span><span class="o">.</span><span class="n">setboundary</span><span class="p">()</span></div>



<div class="viewcode-block" id="enforce_floor_value">
<a class="viewcode-back" href="../../../api/dustpy.std.dust.enforce_floor_value.html#dustpy.std.dust.enforce_floor_value">[docs]</a>
<span class="k">def</span> <span class="nf">enforce_floor_value</span><span class="p">(</span><span class="n">sim</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Function enforces floor value onto dust surface density.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    sim : Frame</span>
<span class="sd">        Parent simulation frame&quot;&quot;&quot;</span>
    <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">Sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
        <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">Sigma</span> <span class="o">&gt;</span> <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">SigmaFloor</span><span class="p">,</span>
        <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">Sigma</span><span class="p">,</span>
        <span class="mf">0.1</span><span class="o">*</span><span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">SigmaFloor</span><span class="p">)</span></div>



<div class="viewcode-block" id="prepare">
<a class="viewcode-back" href="../../../api/dustpy.std.dust.prepare.html#dustpy.std.dust.prepare">[docs]</a>
<span class="k">def</span> <span class="nf">prepare</span><span class="p">(</span><span class="n">sim</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Function prepares implicit dust integration step.</span>
<span class="sd">    It stores the current value of the surface density in a hidden field.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    sim : Frame</span>
<span class="sd">        Parent simulation frame&quot;&quot;&quot;</span>
    <span class="c1"># Setting external sources at boundaries to zero</span>
    <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">S</span><span class="o">.</span><span class="n">ext</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">S</span><span class="o">.</span><span class="n">ext</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="c1"># Storing current surface density</span>
    <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">_SigmaOld</span><span class="p">[</span><span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">Sigma</span><span class="p">[</span><span class="o">...</span><span class="p">]</span></div>



<div class="viewcode-block" id="finalize_explicit">
<a class="viewcode-back" href="../../../api/dustpy.std.dust.finalize_explicit.html#dustpy.std.dust.finalize_explicit">[docs]</a>
<span class="k">def</span> <span class="nf">finalize_explicit</span><span class="p">(</span><span class="n">sim</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Function finalizes integration step.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    sim : Frame</span>
<span class="sd">        Parent integration frame&quot;&quot;&quot;</span>
    <span class="n">boundary</span><span class="p">(</span><span class="n">sim</span><span class="p">)</span>
    <span class="n">enforce_floor_value</span><span class="p">(</span><span class="n">sim</span><span class="p">)</span></div>



<div class="viewcode-block" id="finalize_implicit">
<a class="viewcode-back" href="../../../api/dustpy.std.dust.finalize_implicit.html#dustpy.std.dust.finalize_implicit">[docs]</a>
<span class="k">def</span> <span class="nf">finalize_implicit</span><span class="p">(</span><span class="n">sim</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Function finalizes implicit integration step.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    sim : Frame</span>
<span class="sd">        Parent integration frame&quot;&quot;&quot;</span>
    <span class="n">boundary</span><span class="p">(</span><span class="n">sim</span><span class="p">)</span>
    <span class="n">enforce_floor_value</span><span class="p">(</span><span class="n">sim</span><span class="p">)</span>
    <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">rad</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
    <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">Fi</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
    <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">S</span><span class="o">.</span><span class="n">hyd</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
    <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">S</span><span class="o">.</span><span class="n">coag</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
    <span class="n">set_implicit_boundaries</span><span class="p">(</span><span class="n">sim</span><span class="p">)</span></div>



<div class="viewcode-block" id="set_implicit_boundaries">
<a class="viewcode-back" href="../../../api/dustpy.std.dust.set_implicit_boundaries.html#dustpy.std.dust.set_implicit_boundaries">[docs]</a>
<span class="k">def</span> <span class="nf">set_implicit_boundaries</span><span class="p">(</span><span class="n">sim</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Function calculates the fluxes at the boundaries after the implicit integration step.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    sim : Frame</span>
<span class="sd">        Parent simulation frame&quot;&quot;&quot;</span>
    <span class="c1"># Total source terms</span>
    <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">S</span><span class="o">.</span><span class="n">tot</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">Sigma</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span>
                         <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">_SigmaOld</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">prevstepsize</span><span class="o">+</span><span class="mf">1.e-100</span><span class="p">)</span>
    <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">S</span><span class="o">.</span><span class="n">tot</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">Sigma</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span>
                          <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">_SigmaOld</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">prevstepsize</span><span class="o">+</span><span class="mf">1.e-100</span><span class="p">)</span>
    <span class="c1"># Hydrodynamic source terms</span>
    <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">S</span><span class="o">.</span><span class="n">hyd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">S</span><span class="o">.</span><span class="n">tot</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">S</span><span class="o">.</span><span class="n">hyd</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">S</span><span class="o">.</span><span class="n">tot</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="c1"># Fluxes</span>
    <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">Fi</span><span class="o">.</span><span class="n">adv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.5</span><span class="o">*</span><span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">S</span><span class="o">.</span><span class="n">hyd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">ri</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span>
                                                 <span class="n">sim</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">ri</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">sim</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">ri</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">Fi</span><span class="o">.</span><span class="n">adv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="n">sim</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">ri</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">Fi</span><span class="o">.</span><span class="n">adv</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">Fi</span><span class="o">.</span><span class="n">adv</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">sim</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">ri</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">S</span><span class="o">.</span><span class="n">hyd</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                           <span class="o">*</span> <span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">ri</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="n">sim</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">ri</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span><span class="o">/</span><span class="n">sim</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">ri</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">Fi</span><span class="o">.</span><span class="n">tot</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">Fi</span><span class="o">.</span><span class="n">adv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">Fi</span><span class="o">.</span><span class="n">tot</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">Fi</span><span class="o">.</span><span class="n">adv</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span></div>



<div class="viewcode-block" id="dt_adaptive">
<a class="viewcode-back" href="../../../api/dustpy.std.dust.dt_adaptive.html#dustpy.std.dust.dt_adaptive">[docs]</a>
<span class="k">def</span> <span class="nf">dt_adaptive</span><span class="p">(</span><span class="n">sim</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Function returns the adaptive time step.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    sim : Frame</span>
<span class="sd">        Parent simulation frame</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dt : float</span>
<span class="sd">        Dust time step&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">sim</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">suggested</span></div>



<div class="viewcode-block" id="dt">
<a class="viewcode-back" href="../../../api/dustpy.std.dust.dt.html#dustpy.std.dust.dt">[docs]</a>
<span class="k">def</span> <span class="nf">dt</span><span class="p">(</span><span class="n">sim</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Function calculates the time step from the dust sources.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    sim : Frame</span>
<span class="sd">        Parent simulation frame</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dt : float</span>
<span class="sd">        Dust time step&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">S</span><span class="o">.</span><span class="n">tot</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.</span><span class="p">):</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
            <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">Sigma</span> <span class="o">&gt;</span> <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">SigmaFloor</span><span class="p">,</span>
            <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">S</span><span class="o">.</span><span class="n">tot</span> <span class="o">&lt;</span> <span class="mf">0.</span><span class="p">)</span>
        <span class="n">mask</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">mask</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">rate</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">Sigma</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">/</span> <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">S</span><span class="o">.</span><span class="n">tot</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">rate</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>



<div class="viewcode-block" id="a">
<a class="viewcode-back" href="../../../api/dustpy.std.dust.a.html#dustpy.std.dust.a">[docs]</a>
<span class="k">def</span> <span class="nf">a</span><span class="p">(</span><span class="n">sim</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Function calculates the particle size from the solid density and the filling factor.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    sim : Frame</span>
<span class="sd">        Parent simulation frame</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    a : Field</span>
<span class="sd">        Particle sizes&quot;&quot;&quot;</span>
    <span class="n">rho</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">fill</span> <span class="o">*</span> <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">rhos</span>
    <span class="k">return</span> <span class="n">dust_f</span><span class="o">.</span><span class="n">a</span><span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">m</span><span class="p">,</span> <span class="n">rho</span><span class="p">)</span></div>



<div class="viewcode-block" id="D">
<a class="viewcode-back" href="../../../api/dustpy.std.dust.D.html#dustpy.std.dust.D">[docs]</a>
<span class="k">def</span> <span class="nf">D</span><span class="p">(</span><span class="n">sim</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Function calculates the dust diffusivity.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    sim : Frame</span>
<span class="sd">        Parent simulation frame</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    D : Field</span>
<span class="sd">        Dust diffusivity</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The diffusivity at the first and last two radial</span>
<span class="sd">    grid cells will be set to zero to avoid unwanted</span>
<span class="sd">    behavior at the boundaries.&quot;&quot;&quot;</span>
    <span class="n">v2</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">delta</span><span class="o">.</span><span class="n">rad</span> <span class="o">*</span> <span class="n">sim</span><span class="o">.</span><span class="n">gas</span><span class="o">.</span><span class="n">cs</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">Diff</span> <span class="o">=</span> <span class="n">dust_f</span><span class="o">.</span><span class="n">d</span><span class="p">(</span><span class="n">v2</span><span class="p">,</span> <span class="n">sim</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">OmegaK</span><span class="p">,</span> <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">St</span><span class="p">)</span>
    <span class="n">Diff</span><span class="p">[:</span><span class="mi">2</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="n">Diff</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="k">return</span> <span class="n">Diff</span></div>



<div class="viewcode-block" id="eps">
<a class="viewcode-back" href="../../../api/dustpy.std.dust.eps.html#dustpy.std.dust.eps">[docs]</a>
<span class="k">def</span> <span class="nf">eps</span><span class="p">(</span><span class="n">sim</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Function returns the vertically integrated dust-to-gas ratio.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    sim : Frame</span>
<span class="sd">        Parent simulation frame</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    eps : Field</span>
<span class="sd">        vertically integrated dust-to-gas ratio&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">Sigma</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">sim</span><span class="o">.</span><span class="n">gas</span><span class="o">.</span><span class="n">Sigma</span></div>



<div class="viewcode-block" id="F_adv">
<a class="viewcode-back" href="../../../api/dustpy.std.dust.F_adv.html#dustpy.std.dust.F_adv">[docs]</a>
<span class="k">def</span> <span class="nf">F_adv</span><span class="p">(</span><span class="n">sim</span><span class="p">,</span> <span class="n">Sigma</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Function calculates the advective flux at the cell interfaces. It is linearly interpolating</span>
<span class="sd">    the velocities onto the grid cel interfaces and is assuming</span>
<span class="sd">    vi(0, :) = vi(1, :) and vi(Nr, :) = vi(Nr-1, :).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    sim : Frame</span>
<span class="sd">        Parent simulation frame</span>
<span class="sd">    Sigma : Field, optional, default : None</span>
<span class="sd">        Surface density to be used if not None</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Fi : Field</span>
<span class="sd">        Advective mass fluxes through the grid cell interfaces&quot;&quot;&quot;</span>
    <span class="n">Sigma</span> <span class="o">=</span> <span class="n">Sigma</span> <span class="k">if</span> <span class="n">Sigma</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">Sigma</span>
    <span class="k">return</span> <span class="n">dust_f</span><span class="o">.</span><span class="n">fi_adv</span><span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">Sigma</span><span class="p">,</span> <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">rad</span><span class="p">,</span> <span class="n">sim</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">r</span><span class="p">,</span> <span class="n">sim</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">ri</span><span class="p">)</span></div>



<div class="viewcode-block" id="F_diff">
<a class="viewcode-back" href="../../../api/dustpy.std.dust.F_diff.html#dustpy.std.dust.F_diff">[docs]</a>
<span class="k">def</span> <span class="nf">F_diff</span><span class="p">(</span><span class="n">sim</span><span class="p">,</span> <span class="n">Sigma</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Function calculates the diffusive flux at the cell interfaces&#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">Sigma</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">Sigma</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">Sigma</span>

    <span class="n">Fi</span> <span class="o">=</span> <span class="n">dust_f</span><span class="o">.</span><span class="n">fi_diff</span><span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">D</span><span class="p">,</span>
                        <span class="n">Sigma</span><span class="p">,</span>
                        <span class="n">sim</span><span class="o">.</span><span class="n">gas</span><span class="o">.</span><span class="n">Sigma</span><span class="p">,</span>
                        <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">St</span><span class="p">,</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">delta</span><span class="o">.</span><span class="n">rad</span><span class="o">*</span><span class="n">sim</span><span class="o">.</span><span class="n">gas</span><span class="o">.</span><span class="n">cs</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span>
                        <span class="n">sim</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">r</span><span class="p">,</span>
                        <span class="n">sim</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">ri</span><span class="p">)</span>
    <span class="n">Fi</span><span class="p">[:</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="n">Fi</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mf">0.</span>

    <span class="k">return</span> <span class="n">Fi</span></div>



<div class="viewcode-block" id="F_tot">
<a class="viewcode-back" href="../../../api/dustpy.std.dust.F_tot.html#dustpy.std.dust.F_tot">[docs]</a>
<span class="k">def</span> <span class="nf">F_tot</span><span class="p">(</span><span class="n">sim</span><span class="p">,</span> <span class="n">Sigma</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Function calculates the total mass fluxes through grid cell interfaces.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    sim : Frame</span>
<span class="sd">        Parent simulation frame</span>
<span class="sd">    Sigma : Field, optional, default : None</span>
<span class="sd">        Surface density to be used if not None</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Ftot : Field</span>
<span class="sd">        Total mass flux through interfaces&quot;&quot;&quot;</span>
    <span class="n">Fi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">Fi</span><span class="o">.</span><span class="n">tot</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">Sigma</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">Fdiff</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">Fi</span><span class="o">.</span><span class="n">diff</span>
        <span class="n">Fadv</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">Fi</span><span class="o">.</span><span class="n">adv</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">Fdiff</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">Fi</span><span class="o">.</span><span class="n">diff</span><span class="o">.</span><span class="n">updater</span><span class="o">.</span><span class="n">beat</span><span class="p">(</span><span class="n">sim</span><span class="p">,</span> <span class="n">Sigma</span><span class="o">=</span><span class="n">Sigma</span><span class="p">)</span>
        <span class="n">Fadv</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">Fi</span><span class="o">.</span><span class="n">adv</span><span class="o">.</span><span class="n">updater</span><span class="o">.</span><span class="n">beat</span><span class="p">(</span><span class="n">sim</span><span class="p">,</span> <span class="n">Sigma</span><span class="o">=</span><span class="n">Sigma</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">Fdiff</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">Fi</span> <span class="o">+=</span> <span class="n">Fdiff</span>
    <span class="k">if</span> <span class="n">Fadv</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">Fi</span> <span class="o">+=</span> <span class="n">Fadv</span>
    <span class="k">return</span> <span class="n">Fi</span></div>



<div class="viewcode-block" id="H">
<a class="viewcode-back" href="../../../api/dustpy.std.dust.H.html#dustpy.std.dust.H">[docs]</a>
<span class="k">def</span> <span class="nf">H</span><span class="p">(</span><span class="n">sim</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Function calculates the dust scale height according Dubrulle et al. (1995).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    sim : Frame</span>
<span class="sd">        Parent simulation frame</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    H : Field</span>
<span class="sd">        Dust scale heights&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">dust_f</span><span class="o">.</span><span class="n">h_dubrulle1995</span><span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">gas</span><span class="o">.</span><span class="n">Hp</span><span class="p">,</span> <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">St</span><span class="p">,</span> <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">delta</span><span class="o">.</span><span class="n">vert</span><span class="p">)</span></div>



<div class="viewcode-block" id="jacobian">
<a class="viewcode-back" href="../../../api/dustpy.std.dust.jacobian.html#dustpy.std.dust.jacobian">[docs]</a>
<span class="k">def</span> <span class="nf">jacobian</span><span class="p">(</span><span class="n">sim</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">dx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Function calculates the Jacobian for implicit dust integration.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    sim : Frame</span>
<span class="sd">        Parent simulation frame</span>
<span class="sd">    x : IntVar</span>
<span class="sd">        Integration variable</span>
<span class="sd">    dx : float, optional, default : None</span>
<span class="sd">        stepsize</span>
<span class="sd">    args : additional positional arguments</span>
<span class="sd">    kwargs : additional keyworda arguments</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    jac : Sparse matrix</span>
<span class="sd">        Dust Jacobian</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Function returns the Jacobian for ``Simulation.dust.Sigma.ravel()``</span>
<span class="sd">    instead of ``Simulation.dust.Sigma``. The Jacobian is stored as</span>
<span class="sd">    sparse matrix.&quot;&quot;&quot;</span>

    <span class="c1"># Parameters for function call</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">coagulation</span><span class="o">.</span><span class="n">A</span>
    <span class="n">cstick</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">coagulation</span><span class="o">.</span><span class="n">stick</span>
    <span class="n">eps</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">coagulation</span><span class="o">.</span><span class="n">eps</span>
    <span class="n">ilf</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">coagulation</span><span class="o">.</span><span class="n">lf_ind</span>
    <span class="n">irm</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">coagulation</span><span class="o">.</span><span class="n">rm_ind</span>
    <span class="n">istick</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">coagulation</span><span class="o">.</span><span class="n">stick_ind</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">m</span>
    <span class="n">phi</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">coagulation</span><span class="o">.</span><span class="n">phi</span>
    <span class="n">Rf</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">kernel</span> <span class="o">*</span> <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">frag</span>
    <span class="n">Rs</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">kernel</span> <span class="o">*</span> <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">stick</span>
    <span class="n">SigD</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">Sigma</span>
    <span class="n">SigDfloor</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">SigmaFloor</span>

    <span class="c1"># Helper variables for convenience</span>
    <span class="k">if</span> <span class="n">dx</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">stepsize</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">dx</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">r</span>
    <span class="n">ri</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">ri</span>
    <span class="n">area</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">A</span>
    <span class="n">Nr</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">Nr</span><span class="p">)</span>
    <span class="n">Nm</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">Nm</span><span class="p">)</span>

    <span class="c1"># Building coagulation Jacobian</span>

    <span class="c1"># Total problem size</span>
    <span class="n">Ntot</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">Nr</span><span class="o">*</span><span class="n">Nm</span><span class="p">))</span>
    <span class="c1"># Getting data vector and coordinates in sparse matrix</span>
    <span class="n">dat</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">col</span> <span class="o">=</span> <span class="n">dust_f</span><span class="o">.</span><span class="n">jacobian_coagulation_generator</span><span class="p">(</span>
        <span class="n">A</span><span class="p">,</span> <span class="n">cstick</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span> <span class="n">ilf</span><span class="p">,</span> <span class="n">irm</span><span class="p">,</span> <span class="n">istick</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span> <span class="n">Rf</span><span class="p">,</span> <span class="n">Rs</span><span class="p">,</span> <span class="n">SigD</span><span class="p">,</span> <span class="n">SigDfloor</span><span class="p">)</span>
    <span class="n">gen</span> <span class="o">=</span> <span class="p">(</span><span class="n">dat</span><span class="p">,</span> <span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">))</span>
    <span class="c1"># Building sparse matrix of coagulation Jacobian</span>
    <span class="n">J_coag</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">csc_matrix</span><span class="p">(</span>
        <span class="n">gen</span><span class="p">,</span>
        <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">Ntot</span><span class="p">,</span> <span class="n">Ntot</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># Building the hydrodynamic Jacobian</span>
    <span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">C</span> <span class="o">=</span> <span class="n">dust_f</span><span class="o">.</span><span class="n">jacobian_hydrodynamic_generator</span><span class="p">(</span>
        <span class="n">area</span><span class="p">,</span>
        <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">D</span><span class="p">,</span>
        <span class="n">r</span><span class="p">,</span>
        <span class="n">ri</span><span class="p">,</span>
        <span class="n">sim</span><span class="o">.</span><span class="n">gas</span><span class="o">.</span><span class="n">Sigma</span><span class="p">,</span>
        <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">rad</span>
    <span class="p">)</span>
    <span class="n">J_hyd</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">diags</span><span class="p">(</span>
        <span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">ravel</span><span class="p">()[</span><span class="n">Nm</span><span class="p">:],</span> <span class="n">B</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">C</span><span class="o">.</span><span class="n">ravel</span><span class="p">()[:</span><span class="o">-</span><span class="n">Nm</span><span class="p">]),</span>
        <span class="n">offsets</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="n">Nm</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">Nm</span><span class="p">),</span>
        <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">Ntot</span><span class="p">,</span> <span class="n">Ntot</span><span class="p">),</span>
        <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;csc&quot;</span>
    <span class="p">)</span>

    <span class="c1"># Right-hand side</span>
    <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">_rhs</span><span class="p">[</span><span class="n">Nm</span><span class="p">:</span><span class="o">-</span><span class="n">Nm</span><span class="p">]</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">Sigma</span><span class="o">.</span><span class="n">ravel</span><span class="p">()[</span><span class="n">Nm</span><span class="p">:</span><span class="o">-</span><span class="n">Nm</span><span class="p">]</span>

    <span class="c1"># BOUNDARIES</span>

    <span class="c1"># Inner boundary</span>

    <span class="c1"># Initializing data and coordinate vectors for sparse matrix</span>
    <span class="n">dat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="mf">3.</span><span class="o">*</span><span class="n">Nm</span><span class="p">))</span>
    <span class="n">row0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">Nm</span><span class="p">))</span>
    <span class="n">col0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">Nm</span><span class="p">))</span>
    <span class="n">col1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">Nm</span><span class="p">))</span> <span class="o">+</span> <span class="n">Nm</span>
    <span class="n">col2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">Nm</span><span class="p">))</span> <span class="o">+</span> <span class="mf">2.</span><span class="o">*</span><span class="n">Nm</span>
    <span class="n">row</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">row0</span><span class="p">,</span> <span class="n">row0</span><span class="p">,</span> <span class="n">row0</span><span class="p">))</span>
    <span class="n">col</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">col0</span><span class="p">,</span> <span class="n">col1</span><span class="p">,</span> <span class="n">col2</span><span class="p">))</span>

    <span class="c1"># Filling data vector depending on boundary condition</span>
    <span class="k">if</span> <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">boundary</span><span class="o">.</span><span class="n">inner</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Given value</span>
        <span class="k">if</span> <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">boundary</span><span class="o">.</span><span class="n">inner</span><span class="o">.</span><span class="n">condition</span> <span class="o">==</span> <span class="s2">&quot;val&quot;</span><span class="p">:</span>
            <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">_rhs</span><span class="p">[:</span><span class="n">Nm</span><span class="p">]</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">boundary</span><span class="o">.</span><span class="n">inner</span><span class="o">.</span><span class="n">value</span>
        <span class="c1"># Constant value</span>
        <span class="k">elif</span> <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">boundary</span><span class="o">.</span><span class="n">inner</span><span class="o">.</span><span class="n">condition</span> <span class="o">==</span> <span class="s2">&quot;const_val&quot;</span><span class="p">:</span>
            <span class="n">dat</span><span class="p">[</span><span class="n">Nm</span><span class="p">:</span><span class="mi">2</span><span class="o">*</span><span class="n">Nm</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="n">dt</span>
            <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">_rhs</span><span class="p">[:</span><span class="n">Nm</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="c1"># Given gradient</span>
        <span class="k">elif</span> <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">boundary</span><span class="o">.</span><span class="n">inner</span><span class="o">.</span><span class="n">condition</span> <span class="o">==</span> <span class="s2">&quot;grad&quot;</span><span class="p">:</span>
            <span class="n">K1</span> <span class="o">=</span> <span class="o">-</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">dat</span><span class="p">[</span><span class="n">Nm</span><span class="p">:</span><span class="mi">2</span><span class="o">*</span><span class="n">Nm</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">K1</span><span class="o">/</span><span class="n">dt</span>
            <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">_rhs</span><span class="p">[:</span><span class="n">Nm</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span> <span class="n">ri</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> \
                <span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">boundary</span><span class="o">.</span><span class="n">inner</span><span class="o">.</span><span class="n">value</span>
        <span class="c1"># Constant gradient</span>
        <span class="k">elif</span> <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">boundary</span><span class="o">.</span><span class="n">inner</span><span class="o">.</span><span class="n">condition</span> <span class="o">==</span> <span class="s2">&quot;const_grad&quot;</span><span class="p">:</span>
            <span class="n">Di</span> <span class="o">=</span> <span class="n">ri</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">ri</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">K1</span> <span class="o">=</span> <span class="o">-</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">+</span> <span class="n">Di</span><span class="p">)</span>
            <span class="n">K2</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">Di</span>
            <span class="n">dat</span><span class="p">[:</span><span class="n">Nm</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
            <span class="n">dat</span><span class="p">[</span><span class="n">Nm</span><span class="p">:</span><span class="mi">2</span><span class="o">*</span><span class="n">Nm</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">K1</span><span class="o">/</span><span class="n">dt</span>
            <span class="n">dat</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">Nm</span><span class="p">:]</span> <span class="o">=</span> <span class="o">-</span><span class="n">K2</span><span class="o">/</span><span class="n">dt</span>
            <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">_rhs</span><span class="p">[:</span><span class="n">Nm</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="c1"># Given power law</span>
        <span class="k">elif</span> <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">boundary</span><span class="o">.</span><span class="n">inner</span><span class="o">.</span><span class="n">condition</span> <span class="o">==</span> <span class="s2">&quot;pow&quot;</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">boundary</span><span class="o">.</span><span class="n">inner</span><span class="o">.</span><span class="n">value</span>
            <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">_rhs</span><span class="p">[:</span><span class="n">Nm</span><span class="p">]</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">Sigma</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="n">p</span>
        <span class="c1"># Constant power law</span>
        <span class="k">elif</span> <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">boundary</span><span class="o">.</span><span class="n">inner</span><span class="o">.</span><span class="n">condition</span> <span class="o">==</span> <span class="s2">&quot;const_pow&quot;</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">Sigma</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span>
                       <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">Sigma</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">K1</span> <span class="o">=</span> <span class="o">-</span> <span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="n">p</span>
            <span class="n">dat</span><span class="p">[</span><span class="n">Nm</span><span class="p">:</span><span class="mi">2</span><span class="o">*</span><span class="n">Nm</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">K1</span><span class="o">/</span><span class="n">dt</span>
            <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">_rhs</span><span class="p">[:</span><span class="n">Nm</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>

    <span class="c1"># Creating sparce matrix for inner boundary</span>
    <span class="n">gen</span> <span class="o">=</span> <span class="p">(</span><span class="n">dat</span><span class="p">,</span> <span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">))</span>
    <span class="n">J_in</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">csc_matrix</span><span class="p">(</span>
        <span class="n">gen</span><span class="p">,</span>
        <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">Ntot</span><span class="p">,</span> <span class="n">Ntot</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># Outer boundary</span>

    <span class="c1"># Initializing data and coordinate vectors for sparse matrix</span>
    <span class="n">dat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="mf">3.</span><span class="o">*</span><span class="n">Nm</span><span class="p">))</span>
    <span class="n">row0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">Nm</span><span class="p">))</span>
    <span class="n">col0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">Nm</span><span class="p">))</span>
    <span class="n">col1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">Nm</span><span class="p">))</span> <span class="o">-</span> <span class="n">Nm</span>
    <span class="n">col2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">Nm</span><span class="p">))</span> <span class="o">-</span> <span class="mf">2.</span><span class="o">*</span><span class="n">Nm</span>
    <span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">Nr</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">Nm</span>
    <span class="n">row</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">row0</span><span class="p">,</span> <span class="n">row0</span><span class="p">,</span> <span class="n">row0</span><span class="p">))</span> <span class="o">+</span> <span class="n">offset</span>
    <span class="n">col</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">col0</span><span class="p">,</span> <span class="n">col1</span><span class="p">,</span> <span class="n">col2</span><span class="p">))</span> <span class="o">+</span> <span class="n">offset</span>

    <span class="c1"># Filling data vector depending on boundary condition</span>
    <span class="k">if</span> <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">boundary</span><span class="o">.</span><span class="n">outer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Given value</span>
        <span class="k">if</span> <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">boundary</span><span class="o">.</span><span class="n">outer</span><span class="o">.</span><span class="n">condition</span> <span class="o">==</span> <span class="s2">&quot;val&quot;</span><span class="p">:</span>
            <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">_rhs</span><span class="p">[</span><span class="o">-</span><span class="n">Nm</span><span class="p">:]</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">boundary</span><span class="o">.</span><span class="n">outer</span><span class="o">.</span><span class="n">value</span>
        <span class="c1"># Constant value</span>
        <span class="k">elif</span> <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">boundary</span><span class="o">.</span><span class="n">outer</span><span class="o">.</span><span class="n">condition</span> <span class="o">==</span> <span class="s2">&quot;const_val&quot;</span><span class="p">:</span>
            <span class="n">dat</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">Nm</span><span class="p">:</span><span class="o">-</span><span class="n">Nm</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="n">dt</span>
            <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">_rhs</span><span class="p">[</span><span class="o">-</span><span class="n">Nm</span><span class="p">:]</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="c1"># Given gradient</span>
        <span class="k">elif</span> <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">boundary</span><span class="o">.</span><span class="n">outer</span><span class="o">.</span><span class="n">condition</span> <span class="o">==</span> <span class="s2">&quot;grad&quot;</span><span class="p">:</span>
            <span class="n">KNrm2</span> <span class="o">=</span> <span class="o">-</span><span class="n">r</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="n">r</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">dat</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">Nm</span><span class="p">:</span><span class="o">-</span><span class="n">Nm</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">KNrm2</span><span class="o">/</span><span class="n">dt</span>
            <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">_rhs</span><span class="p">[</span><span class="o">-</span><span class="n">Nm</span><span class="p">:]</span> <span class="o">=</span> <span class="n">ri</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="n">r</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> \
                <span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">r</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span><span class="o">*</span><span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">boundary</span><span class="o">.</span><span class="n">outer</span><span class="o">.</span><span class="n">value</span>
        <span class="c1"># Constant gradient</span>
        <span class="k">elif</span> <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">boundary</span><span class="o">.</span><span class="n">outer</span><span class="o">.</span><span class="n">condition</span> <span class="o">==</span> <span class="s2">&quot;const_grad&quot;</span><span class="p">:</span>
            <span class="n">Do</span> <span class="o">=</span> <span class="n">ri</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="n">ri</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">r</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">r</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">])</span>
            <span class="n">KNrm2</span> <span class="o">=</span> <span class="o">-</span> <span class="n">r</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="n">r</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">+</span> <span class="n">Do</span><span class="p">)</span>
            <span class="n">KNrm3</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span><span class="o">/</span><span class="n">r</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">Do</span>
            <span class="n">dat</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">Nm</span><span class="p">:</span><span class="o">-</span><span class="n">Nm</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">KNrm2</span><span class="o">/</span><span class="n">dt</span>
            <span class="n">dat</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="o">*</span><span class="n">Nm</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">Nm</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">KNrm3</span><span class="o">/</span><span class="n">dt</span>
            <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">_rhs</span><span class="p">[</span><span class="o">-</span><span class="n">Nm</span><span class="p">:]</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="c1"># Given power law</span>
        <span class="k">elif</span> <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">boundary</span><span class="o">.</span><span class="n">outer</span><span class="o">.</span><span class="n">condition</span> <span class="o">==</span> <span class="s2">&quot;pow&quot;</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">boundary</span><span class="o">.</span><span class="n">outer</span><span class="o">.</span><span class="n">value</span>
            <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">_rhs</span><span class="p">[</span><span class="o">-</span><span class="n">Nm</span><span class="p">:]</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">Sigma</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">r</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span><span class="o">**</span><span class="n">p</span>
        <span class="c1"># Constant power law</span>
        <span class="k">elif</span> <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">boundary</span><span class="o">.</span><span class="n">outer</span><span class="o">.</span><span class="n">condition</span> <span class="o">==</span> <span class="s2">&quot;const_pow&quot;</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">Sigma</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span>
                       <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">Sigma</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">])</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="n">r</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">])</span>
            <span class="n">KNrm2</span> <span class="o">=</span> <span class="o">-</span> <span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">r</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span><span class="o">**</span><span class="n">p</span>
            <span class="n">dat</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">Nm</span><span class="p">:</span><span class="o">-</span><span class="n">Nm</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">KNrm2</span><span class="o">/</span><span class="n">dt</span>
            <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">_rhs</span><span class="p">[</span><span class="o">-</span><span class="n">Nm</span><span class="p">:]</span> <span class="o">=</span> <span class="mf">0.</span>

    <span class="c1"># Creating sparce matrix for outer boundary</span>
    <span class="n">gen</span> <span class="o">=</span> <span class="p">(</span><span class="n">dat</span><span class="p">,</span> <span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">))</span>
    <span class="n">J_out</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">csc_matrix</span><span class="p">(</span>
        <span class="n">gen</span><span class="p">,</span>
        <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">Ntot</span><span class="p">,</span> <span class="n">Ntot</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># Adding and returning all matrix components</span>
    <span class="k">return</span> <span class="n">J_in</span> <span class="o">+</span> <span class="n">J_coag</span> <span class="o">+</span> <span class="n">J_hyd</span> <span class="o">+</span> <span class="n">J_out</span></div>



<div class="viewcode-block" id="kernel">
<a class="viewcode-back" href="../../../api/dustpy.std.dust.kernel.html#dustpy.std.dust.kernel">[docs]</a>
<span class="k">def</span> <span class="nf">kernel</span><span class="p">(</span><span class="n">sim</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Function calculates the vertically integrated collision kernel.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    sim : Frame</span>
<span class="sd">        Parent simulation frame</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    K : Field</span>
<span class="sd">        Collision kernel&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">dust_f</span><span class="o">.</span><span class="n">kernel</span><span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">a</span><span class="p">,</span>
                         <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">H</span><span class="p">,</span>
                         <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">Sigma</span><span class="p">,</span>
                         <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">SigmaFloor</span><span class="p">,</span>
                         <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">rel</span><span class="o">.</span><span class="n">tot</span><span class="p">)</span></div>



<div class="viewcode-block" id="MRN_distribution">
<a class="viewcode-back" href="../../../api/dustpy.std.dust.MRN_distribution.html#dustpy.std.dust.MRN_distribution">[docs]</a>
<span class="k">def</span> <span class="nf">MRN_distribution</span><span class="p">(</span><span class="n">sim</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Function calculates the initial particle mass distribution. The parameters are taken from the</span>
<span class="sd">    ``Simulation.ini`` object.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    sim : Frame</span>
<span class="sd">        Parent simulation frame</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Sigma : Field</span>
<span class="sd">        Initial dust surface density</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    ``sim.ini.dust.aIniMax`` : maximum initial particle size</span>
<span class="sd">    ``sim.ini.dust.d2gRatio`` : initial dust-to-gas ratio</span>
<span class="sd">    ``sim.ini.dust.distExp`` : initial particle size distribution ``n(a) da ∝ a^{distExp} da``</span>
<span class="sd">    ``sim.ini.dust.allowDriftingParticles`` : if ``True`` the particle size distribution</span>
<span class="sd">    will be filled up to ``aIniMax``, if ``False`` the maximum particle size will be chosen</span>
<span class="sd">    such that there are no drifting particles initially. This prevents a particle wave traveling</span>
<span class="sd">    though the simulation, that is already drifting initially.&quot;&quot;&quot;</span>
    <span class="n">exp</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">ini</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">distExp</span>
    <span class="c1"># Set maximum particle size</span>
    <span class="k">if</span> <span class="n">sim</span><span class="o">.</span><span class="n">ini</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">allowDriftingParticles</span><span class="p">:</span>
        <span class="n">aIni</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">ini</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">aIniMax</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Calculating pressure gradient</span>
        <span class="n">P</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">gas</span><span class="o">.</span><span class="n">P</span>
        <span class="n">Pi</span> <span class="o">=</span> <span class="n">dust_f</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">ri</span><span class="p">,</span> <span class="n">sim</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">r</span><span class="p">,</span> <span class="n">P</span><span class="p">)</span>
        <span class="n">gamma</span> <span class="o">=</span> <span class="p">(</span><span class="n">Pi</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">Pi</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">ri</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">sim</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">ri</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">gamma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">gamma</span><span class="p">)</span>
        <span class="c1"># Exponent of pressure gradient</span>
        <span class="n">gamma</span> <span class="o">*=</span> <span class="n">sim</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">r</span> <span class="o">/</span> <span class="n">P</span>
        <span class="c1"># Maximum drift limited particle size with safety margin</span>
        <span class="n">ad</span> <span class="o">=</span> <span class="mf">5.e-3</span> <span class="o">*</span> <span class="mf">2.</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">sim</span><span class="o">.</span><span class="n">ini</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">d2gRatio</span> <span class="o">*</span> <span class="n">sim</span><span class="o">.</span><span class="n">gas</span><span class="o">.</span><span class="n">Sigma</span> \
            <span class="o">/</span> <span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">fill</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">rhos</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">OmegaK</span> <span class="o">*</span> <span class="n">sim</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">r</span><span class="p">)</span><span class="o">**</span><span class="mf">2.</span> \
            <span class="o">/</span> <span class="n">sim</span><span class="o">.</span><span class="n">gas</span><span class="o">.</span><span class="n">cs</span><span class="o">**</span><span class="mf">2.</span> <span class="o">/</span> <span class="n">gamma</span>
        <span class="n">aIni</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">ini</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">aIniMax</span><span class="p">,</span> <span class="n">ad</span><span class="p">)[:,</span> <span class="kc">None</span><span class="p">]</span>
    <span class="c1"># Fill distribution</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">a</span> <span class="o">&lt;=</span> <span class="n">aIni</span><span class="p">,</span> <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">a</span><span class="o">**</span><span class="p">(</span><span class="n">exp</span><span class="o">+</span><span class="mi">4</span><span class="p">),</span> <span class="mf">0.</span><span class="p">)</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="o">...</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">s</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="mf">1.</span><span class="p">)</span>
    <span class="c1"># Normalize to mass</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">ret</span> <span class="o">/</span> <span class="n">s</span> <span class="o">*</span> <span class="n">sim</span><span class="o">.</span><span class="n">gas</span><span class="o">.</span><span class="n">Sigma</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">sim</span><span class="o">.</span><span class="n">ini</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">d2gRatio</span>
    <span class="k">return</span> <span class="n">ret</span></div>



<div class="viewcode-block" id="p_stick">
<a class="viewcode-back" href="../../../api/dustpy.std.dust.p_stick.html#dustpy.std.dust.p_stick">[docs]</a>
<span class="k">def</span> <span class="nf">p_stick</span><span class="p">(</span><span class="n">sim</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Function calculates the sticking probability.</span>
<span class="sd">    The sticking probability is simply 1 minus the</span>
<span class="sd">    fragmentation probability.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    sim : Frame</span>
<span class="sd">        Parent simulation frame</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    ps : Field</span>
<span class="sd">        Sticking probability&quot;&quot;&quot;</span>
    <span class="n">p</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">-</span> <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">frag</span>
    <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="n">p</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="k">return</span> <span class="n">p</span></div>



<div class="viewcode-block" id="p_frag">
<a class="viewcode-back" href="../../../api/dustpy.std.dust.p_frag.html#dustpy.std.dust.p_frag">[docs]</a>
<span class="k">def</span> <span class="nf">p_frag</span><span class="p">(</span><span class="n">sim</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Function calculates the fragmentation probability.</span>
<span class="sd">    It assumes a linear transition between sticking and</span>
<span class="sd">    fragmentation.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    sim : Frame</span>
<span class="sd">        Parent simulation frame</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pf : Field</span>
<span class="sd">        Fragmentation propability.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">dust_f</span><span class="o">.</span><span class="n">pfrag</span><span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">rel</span><span class="o">.</span><span class="n">tot</span><span class="p">,</span> <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">frag</span><span class="p">)</span></div>



<div class="viewcode-block" id="rho_midplane">
<a class="viewcode-back" href="../../../api/dustpy.std.dust.rho_midplane.html#dustpy.std.dust.rho_midplane">[docs]</a>
<span class="k">def</span> <span class="nf">rho_midplane</span><span class="p">(</span><span class="n">sim</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Function calculates the midplane mass density.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    sim : Frame</span>
<span class="sd">        Parent simulation frame</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    rho : Field</span>
<span class="sd">        Midplane mass density&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">Sigma</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">c</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">H</span><span class="p">)</span></div>



<div class="viewcode-block" id="S_coag">
<a class="viewcode-back" href="../../../api/dustpy.std.dust.S_coag.html#dustpy.std.dust.S_coag">[docs]</a>
<span class="k">def</span> <span class="nf">S_coag</span><span class="p">(</span><span class="n">sim</span><span class="p">,</span> <span class="n">Sigma</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Function calculates the coagulation source terms.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    sim : Frame</span>
<span class="sd">        Parent simulation Frame</span>
<span class="sd">    Sigma : Field, optional, default : None</span>
<span class="sd">        Surface density to be used if not None</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Scoag : Field</span>
<span class="sd">        Coagulation source terms&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">Sigma</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">Sigma</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">Sigma</span>
    <span class="k">return</span> <span class="n">dust_f</span><span class="o">.</span><span class="n">s_coag</span><span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">coagulation</span><span class="o">.</span><span class="n">stick</span><span class="p">,</span>
                         <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">coagulation</span><span class="o">.</span><span class="n">stick_ind</span><span class="p">,</span>
                         <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">coagulation</span><span class="o">.</span><span class="n">A</span><span class="p">,</span>
                         <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">coagulation</span><span class="o">.</span><span class="n">eps</span><span class="p">,</span>
                         <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">coagulation</span><span class="o">.</span><span class="n">lf_ind</span><span class="p">,</span>
                         <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">coagulation</span><span class="o">.</span><span class="n">rm_ind</span><span class="p">,</span>
                         <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">coagulation</span><span class="o">.</span><span class="n">phi</span><span class="p">,</span>
                         <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">kernel</span> <span class="o">*</span> <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">frag</span><span class="p">,</span>
                         <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">kernel</span> <span class="o">*</span> <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">stick</span><span class="p">,</span>
                         <span class="n">sim</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">m</span><span class="p">,</span>
                         <span class="n">Sigma</span><span class="p">,</span>
                         <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">SigmaFloor</span><span class="p">)</span></div>



<div class="viewcode-block" id="S_hyd">
<a class="viewcode-back" href="../../../api/dustpy.std.dust.S_hyd.html#dustpy.std.dust.S_hyd">[docs]</a>
<span class="k">def</span> <span class="nf">S_hyd</span><span class="p">(</span><span class="n">sim</span><span class="p">,</span> <span class="n">Sigma</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Function calculates the hydrodynamic source terms.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    sim : Frame</span>
<span class="sd">        Parent simulation frame</span>
<span class="sd">    Sigma : Field, optional, default : None</span>
<span class="sd">        Surface density to be used if not None</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Shyd : Field</span>
<span class="sd">        Hydrodynamic source terms&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">Sigma</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">Sigma</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">Sigma</span>
        <span class="n">Fi</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">Fi</span><span class="o">.</span><span class="n">tot</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">Fi</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">Fi</span><span class="o">.</span><span class="n">tot</span><span class="o">.</span><span class="n">updater</span><span class="o">.</span><span class="n">beat</span><span class="p">(</span><span class="n">sim</span><span class="p">,</span> <span class="n">Sigma</span><span class="o">=</span><span class="n">Sigma</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">Fi</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">Fi</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">Fi</span><span class="o">.</span><span class="n">tot</span>
    <span class="k">return</span> <span class="n">dust_f</span><span class="o">.</span><span class="n">s_hyd</span><span class="p">(</span><span class="n">Fi</span><span class="p">,</span> <span class="n">sim</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">ri</span><span class="p">)</span></div>



<div class="viewcode-block" id="S_tot">
<a class="viewcode-back" href="../../../api/dustpy.std.dust.S_tot.html#dustpy.std.dust.S_tot">[docs]</a>
<span class="k">def</span> <span class="nf">S_tot</span><span class="p">(</span><span class="n">sim</span><span class="p">,</span> <span class="n">Sigma</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Function calculates the total source terms.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    sim : Frame</span>
<span class="sd">        Parent simulation frame</span>
<span class="sd">    Sigma : Field, optional, default : None</span>
<span class="sd">        Surface density to be used if not None</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Stot : Field</span>
<span class="sd">        Total source terms of surface density&quot;&quot;&quot;</span>
    <span class="n">Sext</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">S</span><span class="o">.</span><span class="n">ext</span>
    <span class="k">if</span> <span class="n">Sigma</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">Sigma</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">Sigma</span>
        <span class="n">Scoag</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">S</span><span class="o">.</span><span class="n">coag</span>
        <span class="n">Shyd</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">S</span><span class="o">.</span><span class="n">hyd</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">Scoag</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">S</span><span class="o">.</span><span class="n">coag</span><span class="o">.</span><span class="n">updater</span><span class="o">.</span><span class="n">beat</span><span class="p">(</span><span class="n">sim</span><span class="p">,</span> <span class="n">Sigma</span><span class="o">=</span><span class="n">Sigma</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">Scoag</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">Scoag</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">S</span><span class="o">.</span><span class="n">coag</span>
        <span class="n">Shyd</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">S</span><span class="o">.</span><span class="n">hyd</span><span class="o">.</span><span class="n">updater</span><span class="o">.</span><span class="n">beat</span><span class="p">(</span><span class="n">sim</span><span class="p">,</span> <span class="n">Sigma</span><span class="o">=</span><span class="n">Sigma</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">Shyd</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">Shyd</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">S</span><span class="o">.</span><span class="n">hyd</span>
    <span class="k">return</span> <span class="n">Scoag</span> <span class="o">+</span> <span class="n">Shyd</span> <span class="o">+</span> <span class="n">Sext</span></div>



<div class="viewcode-block" id="Sigma_deriv">
<a class="viewcode-back" href="../../../api/dustpy.std.dust.Sigma_deriv.html#dustpy.std.dust.Sigma_deriv">[docs]</a>
<span class="k">def</span> <span class="nf">Sigma_deriv</span><span class="p">(</span><span class="n">sim</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">Sigma</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Function calculates the derivative of the dust surface density.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    sim : Frame</span>
<span class="sd">        Parent simulation frame</span>
<span class="sd">    t : IntVar</span>
<span class="sd">        Current time</span>
<span class="sd">    Sigma : Field</span>
<span class="sd">        Current Surface density</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Sigma_dot: Field</span>
<span class="sd">        Derivative of Surface density&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">S</span><span class="o">.</span><span class="n">tot</span><span class="o">.</span><span class="n">updater</span><span class="o">.</span><span class="n">beat</span><span class="p">(</span><span class="n">sim</span><span class="p">,</span> <span class="n">Sigma</span><span class="o">=</span><span class="n">Sigma</span><span class="p">)</span></div>



<div class="viewcode-block" id="SigmaFloor">
<a class="viewcode-back" href="../../../api/dustpy.std.dust.SigmaFloor.html#dustpy.std.dust.SigmaFloor">[docs]</a>
<span class="k">def</span> <span class="nf">SigmaFloor</span><span class="p">(</span><span class="n">sim</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Function calculates the floor value for the dust distribution. Floor value means that there is less than</span>
<span class="sd">    one particle in an annulus.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    sim : Frame</span>
<span class="sd">        Parent simulation frame</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Sigma_floor : Field</span>
<span class="sd">        Floor value of surface density&quot;&quot;&quot;</span>
    <span class="n">area</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">ri</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">**</span><span class="mf">2.</span> <span class="o">-</span> <span class="n">sim</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">ri</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mf">2.</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">area</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">sim</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">m</span></div>



<div class="viewcode-block" id="St_Epstein_StokesI">
<a class="viewcode-back" href="../../../api/dustpy.std.dust.St_Epstein_StokesI.html#dustpy.std.dust.St_Epstein_StokesI">[docs]</a>
<span class="k">def</span> <span class="nf">St_Epstein_StokesI</span><span class="p">(</span><span class="n">sim</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Function calculates the Stokes number using the Epstein and the Stokes I drag regimes.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    sim : Frame</span>
<span class="sd">        Parent simulation frame</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    St : Field</span>
<span class="sd">        Stokes number&quot;&quot;&quot;</span>
    <span class="n">rho</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">rhos</span> <span class="o">*</span> <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">fill</span>
    <span class="k">return</span> <span class="n">dust_f</span><span class="o">.</span><span class="n">st_epstein_stokes1</span><span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="n">sim</span><span class="o">.</span><span class="n">gas</span><span class="o">.</span><span class="n">mfp</span><span class="p">,</span> <span class="n">rho</span><span class="p">,</span> <span class="n">sim</span><span class="o">.</span><span class="n">gas</span><span class="o">.</span><span class="n">Sigma</span><span class="p">)</span></div>



<div class="viewcode-block" id="coagulation_parameters">
<a class="viewcode-back" href="../../../api/dustpy.std.dust.coagulation_parameters.html#dustpy.std.dust.coagulation_parameters">[docs]</a>
<span class="k">def</span> <span class="nf">coagulation_parameters</span><span class="p">(</span><span class="n">sim</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Function calculates the coagulation parameters needed for a simple</span>
<span class="sd">    sticking-erosion-fragmentation collision model. The sticking matrix</span>
<span class="sd">    is calculated with the method described in appendices A.1. and A.2. of</span>
<span class="sd">    Brauer et al. (2008).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    sim : Frame</span>
<span class="sd">        Parent simulation frame</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    (cstick, cstick_ind, A, eps, klf, krm, phi) : Tuple</span>
<span class="sd">        Coagulation parameters</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The sticking matrix has technically a shape of ``(Nm, Nm, Nm)``.</span>
<span class="sd">    For example: ``cstick(k, j, i)`` describes the change of mass bin ``k``</span>
<span class="sd">    resulting from a sticking collision between particles ``j`` and ``k``.</span>
<span class="sd">    Since this matrix has at maximum four entries per particle collision,</span>
<span class="sd">    only the non-zero elemts are stored in ``cstick`` of shape ``(4, Nm, Nm)``.</span>
<span class="sd">    The positions of the non-zero elements along the first axis are stored</span>
<span class="sd">    in ``cstick_ind``. For details see Brauer et al. (2008).&quot;&quot;&quot;</span>
    <span class="n">cstick</span><span class="p">,</span> <span class="n">cstick_ind</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span> <span class="n">klf</span><span class="p">,</span> <span class="n">krm</span><span class="p">,</span> <span class="n">phi</span> <span class="o">=</span> <span class="n">dust_f</span><span class="o">.</span><span class="n">coagulation_parameters</span><span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">ini</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">erosionMassRatio</span><span class="p">,</span>
                                                                              <span class="n">sim</span><span class="o">.</span><span class="n">ini</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">excavatedMass</span><span class="p">,</span>
                                                                              <span class="n">sim</span><span class="o">.</span><span class="n">ini</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">fragmentDistribution</span><span class="p">,</span>
                                                                              <span class="n">sim</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">m</span><span class="p">,</span>
                                                                              <span class="nb">int</span><span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">Nr</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">cstick</span><span class="p">,</span> <span class="n">cstick_ind</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span> <span class="n">klf</span><span class="p">,</span> <span class="n">krm</span><span class="p">,</span> <span class="n">phi</span></div>



<div class="viewcode-block" id="vdriftmax">
<a class="viewcode-back" href="../../../api/dustpy.std.dust.vdriftmax.html#dustpy.std.dust.vdriftmax">[docs]</a>
<span class="k">def</span> <span class="nf">vdriftmax</span><span class="p">(</span><span class="n">sim</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Function calculates the maximum drift velocity of the dust including back reaction of</span>
<span class="sd">    the gas onto the dust, if the back reaction coefficients are set.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    sim : Frame</span>
<span class="sd">        Parent simulation frame</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    vdriftmax : Field</span>
<span class="sd">        Maximum drift velocity&quot;&quot;&quot;</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">backreaction</span><span class="o">.</span><span class="n">A</span>
    <span class="n">B</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">backreaction</span><span class="o">.</span><span class="n">B</span>
    <span class="k">return</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">B</span> <span class="o">*</span> <span class="n">sim</span><span class="o">.</span><span class="n">gas</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">visc</span> <span class="o">-</span> <span class="n">A</span> <span class="o">*</span> \
        <span class="n">sim</span><span class="o">.</span><span class="n">gas</span><span class="o">.</span><span class="n">eta</span> <span class="o">*</span> <span class="n">sim</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">r</span> <span class="o">*</span> <span class="n">sim</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">OmegaK</span></div>



<div class="viewcode-block" id="vrad">
<a class="viewcode-back" href="../../../api/dustpy.std.dust.vrad.html#dustpy.std.dust.vrad">[docs]</a>
<span class="k">def</span> <span class="nf">vrad</span><span class="p">(</span><span class="n">sim</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Function calculated the radial velocity of the dust.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    sim : Frame</span>
<span class="sd">        Parent simulation frame</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    vrad : Field</span>
<span class="sd">        Radial dust velocity&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">dust_f</span><span class="o">.</span><span class="n">vrad</span><span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">St</span><span class="p">,</span> <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">driftmax</span><span class="p">,</span> <span class="n">sim</span><span class="o">.</span><span class="n">gas</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">rad</span><span class="p">)</span></div>



<div class="viewcode-block" id="vrel_azimuthal_drift">
<a class="viewcode-back" href="../../../api/dustpy.std.dust.vrel_azimuthal_drift.html#dustpy.std.dust.vrel_azimuthal_drift">[docs]</a>
<span class="k">def</span> <span class="nf">vrel_azimuthal_drift</span><span class="p">(</span><span class="n">sim</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Function calculates the relative particle velocities due to azimuthal drift.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    sim : Frame</span>
<span class="sd">        Parent simulation frame</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    vrel : Field</span>
<span class="sd">        Relative velocities&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">dust_f</span><span class="o">.</span><span class="n">vrel_azimuthal_drift</span><span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">driftmax</span><span class="p">,</span> <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">St</span><span class="p">)</span></div>



<div class="viewcode-block" id="vrel_brownian_motion">
<a class="viewcode-back" href="../../../api/dustpy.std.dust.vrel_brownian_motion.html#dustpy.std.dust.vrel_brownian_motion">[docs]</a>
<span class="k">def</span> <span class="nf">vrel_brownian_motion</span><span class="p">(</span><span class="n">sim</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Function calculates the relative particle velocities due to Brownian motion.</span>
<span class="sd">    The maximum value is set to the sound speed.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    sim : Frame</span>
<span class="sd">        Parent simulation frame</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    vrel : Field</span>
<span class="sd">        Relative velocities&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">dust_f</span><span class="o">.</span><span class="n">vrel_brownian_motion</span><span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">gas</span><span class="o">.</span><span class="n">cs</span><span class="p">,</span> <span class="n">sim</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">m</span><span class="p">,</span> <span class="n">sim</span><span class="o">.</span><span class="n">gas</span><span class="o">.</span><span class="n">T</span><span class="p">)</span></div>



<div class="viewcode-block" id="vrel_radial_drift">
<a class="viewcode-back" href="../../../api/dustpy.std.dust.vrel_radial_drift.html#dustpy.std.dust.vrel_radial_drift">[docs]</a>
<span class="k">def</span> <span class="nf">vrel_radial_drift</span><span class="p">(</span><span class="n">sim</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Function calculates the relative particle velocities due to radial drift.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    sim : Frame</span>
<span class="sd">        Parent simulation frame</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    vrel : Field</span>
<span class="sd">        Relative velocities&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">dust_f</span><span class="o">.</span><span class="n">vrel_radial_drift</span><span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">rad</span><span class="p">)</span></div>



<div class="viewcode-block" id="vrel_tot">
<a class="viewcode-back" href="../../../api/dustpy.std.dust.vrel_tot.html#dustpy.std.dust.vrel_tot">[docs]</a>
<span class="k">def</span> <span class="nf">vrel_tot</span><span class="p">(</span><span class="n">sim</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Function calculates the total relative vparticle velocities by taking the root mean square</span>
<span class="sd">    of all individual sources.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    sim : Frame</span>
<span class="sd">        Parent simulation frame</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    vrel : Field</span>
<span class="sd">        Relative velocities&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">rel</span><span class="o">.</span><span class="n">azi</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">rel</span><span class="o">.</span><span class="n">brown</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">rel</span><span class="o">.</span><span class="n">rad</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">rel</span><span class="o">.</span><span class="n">turb</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">rel</span><span class="o">.</span><span class="n">vert</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span></div>



<div class="viewcode-block" id="vrel_turbulent_motion">
<a class="viewcode-back" href="../../../api/dustpy.std.dust.vrel_turbulent_motion.html#dustpy.std.dust.vrel_turbulent_motion">[docs]</a>
<span class="k">def</span> <span class="nf">vrel_turbulent_motion</span><span class="p">(</span><span class="n">sim</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Function calculates the relative particle velocities due to turbulent motion.</span>
<span class="sd">    It uses the prescription of Ormel &amp; Cuzzi (2007).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    sim : Frame</span>
<span class="sd">        Parent simulation frame</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    vrel : Field</span>
<span class="sd">        Relative velocities&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">dust_f</span><span class="o">.</span><span class="n">vrel_ormel_cuzzi_2007</span><span class="p">(</span>
        <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">delta</span><span class="o">.</span><span class="n">turb</span><span class="p">,</span>
        <span class="n">sim</span><span class="o">.</span><span class="n">gas</span><span class="o">.</span><span class="n">cs</span><span class="p">,</span>
        <span class="n">sim</span><span class="o">.</span><span class="n">gas</span><span class="o">.</span><span class="n">mu</span><span class="p">,</span>
        <span class="n">sim</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">OmegaK</span><span class="p">,</span>
        <span class="n">sim</span><span class="o">.</span><span class="n">gas</span><span class="o">.</span><span class="n">Sigma</span><span class="p">,</span>
        <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">St</span><span class="p">)</span></div>



<div class="viewcode-block" id="vrel_vertical_settling">
<a class="viewcode-back" href="../../../api/dustpy.std.dust.vrel_vertical_settling.html#dustpy.std.dust.vrel_vertical_settling">[docs]</a>
<span class="k">def</span> <span class="nf">vrel_vertical_settling</span><span class="p">(</span><span class="n">sim</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Function calculates the relative particle velocities due to vertical settling.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    sim : Frame</span>
<span class="sd">        Parent simulation frame</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    vrel : Field</span>
<span class="sd">        Relative velocities&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">dust_f</span><span class="o">.</span><span class="n">vrel_vertical_settling</span><span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">H</span><span class="p">,</span> <span class="n">sim</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">OmegaK</span><span class="p">,</span> <span class="n">sim</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">St</span><span class="p">)</span></div>



<span class="k">def</span> <span class="nf">_f_impl_1_direct</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">Y0</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">jac</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rhs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Implicit 1st-order integration scheme with direct matrix inversion</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x0 : Intvar</span>
<span class="sd">        Integration variable at beginning of scheme</span>
<span class="sd">    Y0 : Field</span>
<span class="sd">        Variable to be integrated at the beginning of scheme</span>
<span class="sd">    dx : IntVar</span>
<span class="sd">        Stepsize of integration variable</span>
<span class="sd">    jac : Field, optional, defaul : None</span>
<span class="sd">        Current Jacobian. Will be calculated, if not set</span>
<span class="sd">    args : additional positional arguments</span>
<span class="sd">    kwargs : additional keyworda arguments</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dY : Field</span>
<span class="sd">        Delta of variable to be integrated</span>

<span class="sd">    Butcher tableau</span>
<span class="sd">    ---------------</span>
<span class="sd">     1 | 1</span>
<span class="sd">    ---|---</span>
<span class="sd">       | 1</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">jac</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">jac</span> <span class="o">=</span> <span class="n">Y0</span><span class="o">.</span><span class="n">jacobian</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">dx</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">rhs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">rhs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Y0</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span>

    <span class="n">Nm</span> <span class="o">=</span> <span class="n">Y0</span><span class="o">.</span><span class="n">_owner</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">Sigma</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># Add external source terms to right-hand side</span>
    <span class="n">rhs</span><span class="p">[</span><span class="n">Nm</span><span class="p">:</span><span class="o">-</span><span class="n">Nm</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dx</span><span class="o">*</span><span class="n">Y0</span><span class="o">.</span><span class="n">_owner</span><span class="o">.</span><span class="n">dust</span><span class="o">.</span><span class="n">S</span><span class="o">.</span><span class="n">ext</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

    <span class="n">N</span> <span class="o">=</span> <span class="n">jac</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">eye</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">identity</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;csc&quot;</span><span class="p">)</span>

    <span class="n">A</span> <span class="o">=</span> <span class="n">eye</span> <span class="o">-</span> <span class="n">dx</span> <span class="o">*</span> <span class="n">jac</span>

    <span class="n">A_LU</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">splu</span><span class="p">(</span><span class="n">A</span><span class="p">,</span>
                          <span class="n">permc_spec</span><span class="o">=</span><span class="s2">&quot;MMD_AT_PLUS_A&quot;</span><span class="p">,</span>
                          <span class="n">diag_pivot_thresh</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
                          <span class="n">options</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">SymmetricMode</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
    <span class="n">Y1_ravel</span> <span class="o">=</span> <span class="n">A_LU</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">rhs</span><span class="p">)</span>

    <span class="n">Y1</span> <span class="o">=</span> <span class="n">Y1_ravel</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">Y0</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">Y1</span> <span class="o">-</span> <span class="n">Y0</span>


<div class="viewcode-block" id="impl_1_direct">
<a class="viewcode-back" href="../../../api/dustpy.std.dust.impl_1_direct.html#dustpy.std.dust.impl_1_direct">[docs]</a>
<span class="k">class</span> <span class="nc">impl_1_direct</span><span class="p">(</span><span class="n">Scheme</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Modified class for implicit dust integration.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">_f_impl_1_direct</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Implicit 1st-order direct solver&quot;</span><span class="p">)</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2020-2023, Sebastian Stammler &amp; Tilman Birnstiel.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>